# CortenForge Quality Gate
#
# This workflow enforces the A-grade standard on every push and PR.
# See STANDARDS.md for the seven criteria.
# See INFRASTRUCTURE.md for the full constraint specification.
#
# "A-grade or it doesn't ship. No exceptions."

name: Quality Gate

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  RUSTDOCFLAGS: "-D warnings"

jobs:
  # ============================================================================
  # FORMATTING - Must be exact
  # ============================================================================
  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  # ============================================================================
  # CLIPPY - Zero warnings
  # ============================================================================
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # ============================================================================
  # TESTS - All must pass on all platforms
  # ============================================================================
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --all-features

  # ============================================================================
  # TESTS - ARM64 (Apple Silicon and Linux ARM)
  # ============================================================================
  test-arm64:
    name: Test (ARM64)
    runs-on: macos-latest  # GitHub's macos-latest is now ARM64
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Verify ARM64
        run: |
          echo "Architecture: $(uname -m)"
          if [ "$(uname -m)" != "arm64" ]; then
            echo "::warning::Expected ARM64, got $(uname -m)"
          fi

      - name: Run tests
        run: cargo test --all-features

  # ============================================================================
  # WASM - Layer 0 crates must compile to WebAssembly
  # ============================================================================
  wasm:
    name: WASM Compatibility
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check WASM compatibility (Layer 0)
        run: |
          # Layer 0 crates must build for WASM
          # Note: Some crates may need --no-default-features to exclude std-only deps
          WASM_CRATES=(
            "mesh-types"
            "mesh-geodesic"
            "mesh-transform"
            "mesh-measure"
            "mesh-slice"
            "sensor-types"
            "ml-types"
            "sim-types"
            "sim-core"
            "sim-contact"
            "sim-constraint"
            "sim-urdf"
            "sim-physics"
          )

          for crate in "${WASM_CRATES[@]}"; do
            echo "Checking $crate for WASM..."
            if cargo check -p "$crate" --target wasm32-unknown-unknown 2>/dev/null; then
              echo "✓ $crate builds for WASM"
            else
              echo "::warning::$crate does not build for WASM (may need feature flags)"
            fi
          done

  # ============================================================================
  # DOCUMENTATION - Zero warnings, complete coverage
  # ============================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build docs
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: "-D warnings"

  # ============================================================================
  # COVERAGE - Must be ≥90% for A-grade
  # ============================================================================
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Generate coverage and check threshold
        run: |
          # Run tarpaulin with 75% threshold - fails if coverage below threshold
          # TODO: Increase to 90% as test coverage improves
          cargo tarpaulin --all-features --workspace --fail-under 75

  # ============================================================================
  # SAFETY - Zero unwrap/expect in library code
  # ============================================================================
  safety:
    name: Safety
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check for unwrap/expect
        run: |
          # Find all library source files (exclude tests, examples, xtask)
          # Also exclude doc comments (/// and //!) and test modules (#[cfg(test)])
          FOUND_VIOLATIONS=false

          for file in $(find . -name "*.rs" \
            -not -path "./target/*" \
            -not -path "./xtask/*" \
            -not -path "*/tests/*" \
            -not -path "*/examples/*" \
            -not -path "*/benches/*" 2>/dev/null); do

            # Use awk to find unwrap/expect outside of:
            # - doc comments (lines starting with /// or //!)
            # - test modules (from #[cfg(test)] to end of file)
            VIOLATIONS=$(awk '
              /^[ \t]*#\[cfg\(test\)\]/ { in_test = 1 }
              !in_test && !/^[ \t]*\/\/[\/!]/ && /\.(unwrap|expect)\(/ { print NR": "$0 }
            ' "$file" 2>/dev/null)

            if [ -n "$VIOLATIONS" ]; then
              if [ "$FOUND_VIOLATIONS" = false ]; then
                echo "::error::Found unwrap/expect in library code:"
                FOUND_VIOLATIONS=true
              fi
              echo "In $file:"
              echo "$VIOLATIONS" | head -5
            fi
          done

          if [ "$FOUND_VIOLATIONS" = true ]; then
            exit 1
          fi
          echo "✓ No unwrap/expect found in library code"

      - name: Check for panic!/todo!/unimplemented!
        run: |
          VIOLATIONS=$(find . -name "*.rs" \
            -not -path "./target/*" \
            -not -path "./xtask/*" \
            -not -path "*/tests/*" \
            -not -path "*/examples/*" \
            -exec grep -l -E 'panic!\(|todo!\(|unimplemented!\(' {} \; 2>/dev/null || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "::warning::Found panic!/todo!/unimplemented! (review required):"
            echo "$VIOLATIONS"
          fi

  # ============================================================================
  # SECURITY - Vulnerability scanning
  # ============================================================================
  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        # Using continue-on-error temporarily while dependency vulnerabilities
        # are being addressed. TODO: Remove once deps are updated
        continue-on-error: true
        run: |
          cargo audit --deny warnings || echo "::warning::Security vulnerabilities found - see above for details"

  # ============================================================================
  # DEPENDENCIES - Audit and policy
  # ============================================================================
  dependencies:
    name: Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deny
        run: cargo install cargo-deny

      - name: Check dependencies
        run: cargo deny check

  # ============================================================================
  # SEMVER - Breaking change detection
  # ============================================================================
  semver:
    name: Semver
    runs-on: ubuntu-latest
    # Only run on PRs (compare against base branch)
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check semver compatibility
        uses: obi1kenobi/cargo-semver-checks-action@v2
        # Only check crates that are published to crates.io
        # New/unpublished crates should be added here once published
        with:
          # For now, only check mesh-repair which has a published baseline
          # Other crates are not yet on crates.io
          package: mesh-repair
        continue-on-error: true  # Don't block PRs on semver for now

  # ============================================================================
  # LAYER 0 - No Bevy in foundation crates
  # ============================================================================
  bevy-free:
    name: Bevy-Free (Layer 0)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check Layer 0 crates
        run: |
          # List of Layer 0 crates that must be Bevy-free
          LAYER0_CRATES=(
            "mesh-types"
            "mesh-io"
            "mesh-repair"
            "mesh-geodesic"
            "mesh-transform"
            "mesh-sdf"
            "mesh-offset"
            "mesh-zones"
            "mesh-from-curves"
            "mesh-shell"
            "mesh-measure"
            "mesh-thickness"
            "mesh-slice"
            "mesh-decimate"
            "mesh-subdivide"
            "mesh-remesh"
            "mesh-region"
            "mesh-assembly"
            "mesh-printability"
            "mesh-boolean"
            "mesh-registration"
            "mesh-morph"
            "mesh-scan"
            "mesh-lattice"
            "mesh-template"
            "sensor-types"
            "sensor-fusion"
            "ml-types"
            "ml-models"
            "ml-dataset"
            "ml-training"
            "sim-types"
            "sim-core"
            "sim-contact"
            "sim-constraint"
            "sim-urdf"
            "sim-physics"
          )

          FAILED=false
          for crate in "${LAYER0_CRATES[@]}"; do
            if cargo tree -p "$crate" 2>/dev/null | grep -qi "bevy"; then
              echo "::error::$crate has Bevy in dependency tree"
              FAILED=true
            fi
          done

          if [ "$FAILED" = true ]; then
            exit 1
          fi
          echo "✓ All Layer 0 crates are Bevy-free"

  # ============================================================================
  # SBOM - Software Bill of Materials generation
  # ============================================================================
  sbom:
    name: SBOM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx

      - name: Generate SBOM
        run: |
          cargo cyclonedx --format json
          # Find and rename the generated SBOM (name varies by workspace structure)
          find . -name "*.cdx.json" -not -path "./target/*" | head -1 | xargs -I{} cp {} sbom.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v6
        with:
          name: sbom
          path: sbom.json

  # ============================================================================
  # FINAL GATE
  # ============================================================================
  quality-gate:
    name: Quality Gate
    needs: [format, clippy, test, test-arm64, docs, safety, security, dependencies, bevy-free]
    runs-on: ubuntu-latest
    steps:
      - name: All checks passed
        run: |
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║                    QUALITY GATE PASSED                        ║"
          echo "║                                                              ║"
          echo "║  All automated criteria meet A-grade standard.               ║"
          echo "║  Ready for API review and merge.                             ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
